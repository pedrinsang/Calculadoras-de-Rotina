<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mural de Tarefas</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #87daa0, #51c778);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      overflow: hidden; /* Remove scroll global */
    }

    h1 {
      font-size: 2rem;
      display: flex;
      justify-content: center;
    }

    .container-fora {
      width: 100%;
      max-width: min(95vw, 900px); /* Limite máximo adaptável */
      height: min(95vh, 740px); /* Altura máxima = altura da tela */
      padding: 15px;
      background: white;
      color: #1b5e20;
      border-radius: 10px;
      box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .button {
      padding: 10px 20px;
      background-color: #1b5e20;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      transition: background-color 0.3s;
      border: none;
      cursor: pointer;
    }

    .button:hover {
      background-color: #166534;
    }

    .container-botoes {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    .container-tarefa {
      display: flex;
      justify-content: center;
      margin: 10px 0;
    }

    #mural-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px 5px;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      max-height: calc(100vh - 220px); /* Ajuste preciso para telas pequenas */
    }

    .amostra-item {
      background-color: #f9f9f9;
      padding: 12px 15px;
      margin-bottom: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .amostra-item.em-progresso {
      background-color: #e3f2fd;
      border-left: 5px solid #1e3a8a;
    }

    .status-buttons {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
    }

    .btn-progresso, .btn-concluido, .btn-resultado {
      padding: 8px 12px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-progresso {
      background-color: #201b5e;
      color: white;
    }

    .btn-concluido {
      background-color: #1b5e20;
      color: white;
    }

    .btn-resultado {
      background-color: #e67e22;
      color: white;
    }

    .actions-dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-toggle {
      padding: 8px 15px;
      background: #5e1b59;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .dropdown-toggle::after {
      content: "▼";
      font-size: 10px;
      margin-left: 5px;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: white;
      box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: 5px;
      min-width: 150px;
    }

    .dropdown-content button {
      width: 100%;
      padding: 10px;
      text-align: left;
      border: none;
      background: white;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      border-bottom: 1px solid #eee;
    }

    .dropdown-content button:hover {
      background-color: #f1f1f1;
    }

    .actions-dropdown.active .dropdown-content {
      display: block;
    }

    #mural-form {
      display: none;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      max-height: 75vh;
      overflow-y: auto;
    }

    #mural-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    #mural-form input, #mural-form select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }

    #mural-form button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }

    #mural-form button[type="submit"] {
      background-color: #1b5e20;
      color: white;
    }

    #mural-form button[type="button"] {
      background-color: #ccc;
      color: #333;
      margin-left: 10px;
    }

    .filtros-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
      align-items: center;
      justify-content: space-between;
    }

    .filtro-container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    .filtro-container label {
      font-weight: bold;
      white-space: nowrap;
    }

    .filtro-container select {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 16px;
      min-width: 150px;
    }

    #loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .feedback {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 5px;
      color: white;
      z-index: 1000;
      animation: slideIn 0.5s, fadeOut 0.5s 2.5s forwards;
    }

    .feedback.success {
      background-color: #1b5e20;
    }

    .feedback.error {
      background-color: #d32f2f;
    }

    /* Barra de rolagem */
    #mural-list::-webkit-scrollbar,
    #mural-form::-webkit-scrollbar {
      width: 8px;
    }

    #mural-list::-webkit-scrollbar-track,
    #mural-form::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    #mural-list::-webkit-scrollbar-thumb,
    #mural-form::-webkit-scrollbar-thumb {
      background: #1b5e20;
      border-radius: 4px;
    }

    #mural-list::-webkit-scrollbar-thumb:hover,
    #mural-form::-webkit-scrollbar-thumb:hover {
      background: #166534;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Modal de resultados */
    .modal-resultados {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-resultados-content {
      background: white;
      padding: 25px;
      border-radius: 10px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      width: 600px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      position: relative;
    }

    .tabela-resultados {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }

    .tabela-resultados th, .tabela-resultados td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    .tabela-resultados th {
      background-color: #1b5e20;
      color: white;
    }

    .tabela-resultados tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    h1 {
      margin-bottom: 10px;
    }

    /* Estilos para mobile */
    @media (max-width: 768px) {
      .container-fora {
        max-height: 85vh;
        padding: 15px;
      }

      .filtros-wrapper {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filtro-container {
        width: 100%;
        justify-content: space-between;
      }
      
      .filtro-container select {
        flex-grow: 1;
      }

     #mural-list {
        max-height: calc(100% - 140px); /* Ajuste fino */
      }

      .status-buttons {
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
      }

      .btn-progresso, 
      .btn-concluido,
      .btn-resultado,
      .dropdown-toggle {
        width: 100%;
        text-align: center;
      }

      .dropdown-content {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 300px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .container-fora {
        max-height: 80vh;
        padding: 12px;
      }

      #mural-list {
        max-height: calc(100% - 130px);
        padding: 10px;
      }

      .button {
        padding: 8px 12px;
        font-size: 14px;
        width: 49%;
      }
    }
    

    @media (max-width: 360px) {
      .container-fora {
        padding: 10px;
        height: min(98vh, 740px);
      }

      h1 {
        font-size: 1.3rem;
      }

      #mural-list {
        max-height: calc(100vh - 180px); /* Ajuste extra para telas muito pequenas */
        padding: 5px;
      }

      .button {
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container-fora">
    <div id="loading">
      <div style="background: white; padding: 20px; border-radius: 5px;">
        Carregando...
      </div>
    </div>

    <div class="container">
      <h1>Mural de Tarefas</h1>

      <div class="container-botoes">
        <button id="hub-button" class="button">Voltar ao Hub</button>
        <button id="historico-button" class="button">Acessar Histórico</button>
      </div>
      <div class="container-tarefa">
        <button id="adicionar-tarefa" class="button">Adicionar Tarefa</button>
      </div>


      <div class="filtros-wrapper">
        <div class="filtro-container">
          <label>Filtrar por tipo: </label>
          <select id="filtro-tipo">
            <option value="Todos">Todos</option>
            <option value="SN BVDV">SN BVDV</option>
            <option value="SN IBR">SN IBR</option>
            <option value="Vacina">VACINA</option>
            <option value="ELISA LEUCOSE">ELISA LEUCOSE</option>
            <option value="ELISA BVDV">ELISA BVDV</option>
            <option value="PCR">PCR</option>
            <option value="RAIVA">Raiva</option>
          </select>
        </div>
        <div class="filtro-container">
          <label>Ordenar por: </label>
          <select id="filtro-ordem">
            <option value="recentes">Mais recentes</option>
            <option value="antigas">Mais antigas</option>
          </select>
        </div>
      </div>

      <form id="mural-form">
        <label for="id">Número de Identificação:</label>
        <input type="text" id="id" name="id" required>

        <label for="tipo">Tipo de Amostra:</label>
        <select id="tipo" name="tipo" required>
          <option value="SN BVDV">SN BVDV</option>
          <option value="SN IBR">SN IBR</option>
          <option value="VACINA">VACINA</option>
          <option value="ELISA LEUCOSE">ELISA LEUCOSE</option>
          <option value="ELISA BVDV">ELISA BVDV</option>
          <option value="PCR">PCR</option>
          <option value="RAIVA">RAIVA</option>
        </select>

        <div id="complemento-container" style="display: none;">
          <label for="complemento">Complemento:</label>
          <input type="text" id="complemento" name="complemento">
        </div>

        <label for="quantidade">Quantidade:</label>
        <input type="number" id="quantidade" name="quantidade" min="1" required>

        <div id="gramatura-container" style="display: none;">
          <label for="gramatura">Gramatura (apenas para Vacina):</label>
          <input type="number" id="gramatura" name="gramatura" step="0.01">
        </div>

        <label for="proprietario">Proprietário:</label>
        <input type="text" id="proprietario" name="proprietario" list="proprietarios-list">
        <datalist id="proprietarios-list"></datalist>

        <label for="data">Data de Recebimento:</label>
        <input type="date" id="data" name="data" required>

        <label for="observacoes">Observações:</label>
        <textarea id="observacoes" name="observacoes" rows="3" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px;"></textarea>

        <button type="submit">Salvar Tarefa</button>
        <button type="button" id="cancelar-tarefa">Cancelar</button>
      </form>

      <div id="mural-list"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs, 
      doc, 
      updateDoc, 
      deleteDoc, 
      Timestamp, 
      query, 
      where,
      orderBy,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyAJneFO6AYsj5_w3hIKzPGDa8yR6Psng4M",
      authDomain: "hub-de-calculadoras.firebaseapp.com",
      projectId: "hub-de-calculadoras",
      storageBucket: "hub-de-calculadoras.appspot.com",
      messagingSenderId: "203883856586",
      appId: "1:203883856586:web:a00536536a32ae76c5aa33",
      measurementId: "G-7H314CT9SH"
    };  
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    document.addEventListener('DOMContentLoaded', function() {
        console.log("Desenvolvido por Pedro Ruiz Sangoi e Alexandre Werle Suares, com auxílio do DeepSeek Chat.");
    });
  
    // Funções de UI
    function mostrarLoading() {
      document.getElementById("loading").style.display = "flex";
    }
  
    function esconderLoading() {
      document.getElementById("loading").style.display = "none";
    }
  
    function mostrarFeedback(mensagem, tipo = "success") {
      const feedback = document.createElement("div");
      feedback.className = `feedback ${tipo}`;
      feedback.textContent = mensagem;
      document.body.appendChild(feedback);
      
      setTimeout(() => {
        feedback.remove();
      }, 3000);
    }
  
    function mostrarFormulario(edicao = false) {
      const form = document.getElementById("mural-form");
      const muralList = document.getElementById("mural-list");
      const adicionarTarefaBtn = document.getElementById("adicionar-tarefa");
      const filtrosWrapper = document.querySelector(".filtros-wrapper"); // Adicionado
      
      form.style.display = "block";
      muralList.style.display = "none";
      adicionarTarefaBtn.style.display = "none";
      filtrosWrapper.style.display = "none"; // Adicionado
      
      if (!edicao) {
        form.reset();
        form.onsubmit = adicionarTarefa;
      }
    }
  
    function esconderFormulario() {
      document.getElementById("mural-form").style.display = "none";
      document.getElementById("mural-list").style.display = "block";
      document.getElementById("adicionar-tarefa").style.display = "block";
      document.querySelector(".filtros-wrapper").style.display = "flex"; // Adicionado
    }
  
    // Funções auxiliares para datas
    function normalizarDataParaUTC(dataString) {
      const dataLocal = new Date(dataString);
      return new Date(Date.UTC(
        dataLocal.getFullYear(),
        dataLocal.getMonth(),
        dataLocal.getDate()
      ));
    }
  
    function formatarDataParaExibicao(dataUTC) {
      return dataUTC.toLocaleDateString("pt-BR", {
        timeZone: "America/Sao_Paulo",
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      });
    }
  
    // Funções de Tarefas
    async function carregarTarefas(filtro = "Todos", ordem = "recentes") {
      mostrarLoading();
      const muralList = document.getElementById("mural-list");
      muralList.innerHTML = "<p>Carregando tarefas...</p>";
  
      try {
        const user = auth.currentUser;
        if (!user) throw new Error("Usuário não autenticado");
  
        let q;
        if (filtro === "Todos") {
          q = query(
            collection(db, "tarefas"), 
            orderBy("criadoEm", ordem === "recentes" ? "desc" : "asc")
          );
        } else {
          q = query(
            collection(db, "tarefas"),
            where("tipo", "==", filtro),
            orderBy("criadoEm", ordem === "recentes" ? "desc" : "asc")
          );
        }
  
        const querySnapshot = await getDocs(q);
    
        if (querySnapshot.empty) {
          muralList.innerHTML = "<p>Nenhuma tarefa encontrada.</p>";
          return;
        }
  
        muralList.innerHTML = "";
        querySnapshot.forEach((doc) => {
          const tarefa = doc.data();
          const dataRecebimento = tarefa.dataRecebimento?.toDate 
            ? formatarDataParaExibicao(tarefa.dataRecebimento.toDate())
            : "Data não disponível";
          
          const statusClass = tarefa.status === 'em-progresso' ? 'em-progresso' : '';
          
          const amostraItem = document.createElement("div");
          amostraItem.className = `amostra-item ${statusClass}`;
          amostraItem.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>ID:</strong> ${tarefa.id}<br>
                  <strong>Tipo:</strong> ${tarefa.tipo}<br>
                  <strong>Quantidade:</strong> ${tarefa.quantidade || '0'}
                </div>
                <div class="status-buttons">
                  <button class="btn-progresso" onclick="marcarProgresso('${doc.id}')">Progresso</button>
                  <button class="btn-concluido" onclick="concluirTarefa('${doc.id}')">Concluir</button>
                  <button class="btn-resultado" onclick="registrarResultado('${doc.id}')">Resultado</button>
                  
                  <div class="actions-dropdown">
                    <button class="dropdown-toggle">Mais</button>
                    <div class="dropdown-content">
                      <button onclick="mostrarDetalhes('${doc.id}')">Detalhes</button>
                      <button onclick="editarTarefa('${doc.id}')">Editar</button>
                      <button onclick="excluirTarefa('${doc.id}')">Excluir</button>
                    </div>
                  </div>
                </div>
              </div>
            `;
          muralList.appendChild(amostraItem);
      });

      // Adicione esta nova função
      window.registrarResultado = async (id) => {
          try {
            mostrarLoading();
            
            // Obter os dados da tarefa
            const tarefaRef = doc(db, "tarefas", id);
            const tarefaSnap = await getDoc(tarefaRef);
            
            if (!tarefaSnap.exists()) throw new Error("Tarefa não encontrada");
            
            const tarefa = tarefaSnap.data();
            
            // Verificar se é um tipo que tem resultados (SN IBR ou SN BVDV)
            if (tarefa.tipo !== "SN IBR" && tarefa.tipo !== "SN BVDV") {
              mostrarFeedback("Este tipo de tarefa não possui resultados específicos", "error");
              return;
            }
            
            // Criar o modal de resultados
            const modal = document.createElement("div");
            modal.className = "modal-resultados";
            
            // Criar a tabela de resultados
            const resultadosHTML = `
              <div class="modal-resultados-content">
                <h3 style="margin-bottom: 15px; color: #1b5e20;">Registrar Resultados - ${tarefa.tipo}</h3>
                <p><strong>ID:</strong> ${tarefa.id} | <strong>Quantidade:</strong> ${tarefa.quantidade} amostras</p>
                
                <table class="tabela-resultados">
                  <thead>
                    <tr>
                      <th>Resultado</th>
                      <th>Identificação das amostras</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Negativas (&lt; 1:4)</td>
                      <td><input type="text" id="negativas" value="${tarefa.resultados?.negativas || ''}"></td>
                    </tr>
                    <tr>
                      <td colspan="2" style="text-align: center; font-weight: bold;">Positivas</td>
                    </tr>
                    <tr>
                      <td>Título 4</td>
                      <td><input type="text" id="titulo4" value="${tarefa.resultados?.titulo4 || ''}"></td>
                    </tr>
                    <tr>
                      <td>Título 8</td>
                      <td><input type="text" id="titulo8" value="${tarefa.resultados?.titulo8 || ''}"></td>
                    </tr>
                    <tr>
                      <td>Título 16</td>
                      <td><input type="text" id="titulo16" value="${tarefa.resultados?.titulo16 || ''}"></td>
                    </tr>
                    <tr>
                      <td>Título 32</td>
                      <td><input type="text" id="titulo32" value="${tarefa.resultados?.titulo32 || ''}"></td>
                    </tr>
                    <tr>
                      <td>Título 64</td>
                      <td><input type="text" id="titulo64" value="${tarefa.resultados?.titulo64 || ''}"></td>
                    </tr>
                    <tr>
                      <td>Título 128</td>
                      <td><input type="text" id="titulo128" value="${tarefa.resultados?.titulo128 || ''}"></td>
                    </tr>
                    <tr>
                      <td>Título ≥256</td>
                      <td><input type="text" id="titulo256" value="${tarefa.resultados?.titulo256 || ''}"></td>
                    </tr>
                    <tr>
                      <td>Título ≥512</td>
                      <td><input type="text" id="titulo512" value="${tarefa.resultados?.titulo512 || ''}"></td>
                    </tr>
                    <tr>
                      <td>Impróprias para testar</td>
                      <td><input type="text" id="improprias" value="${tarefa.resultados?.improprias || ''}"></td>
                    </tr>
                    <tr>
                      <td>Tóxicas</td>
                      <td><input type="text" id="toxicas" value="${tarefa.resultados?.toxicas || ''}"></td>
                    </tr>
                    <tr>
                      <td>Quantidade insuficiente</td>
                      <td><input type="text" id="insuficiente" value="${tarefa.resultados?.insuficiente || ''}"></td>
                    </tr>
                  </tbody>
                </table>
                
                <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                  <button id="cancelar-resultados" class="button" style="background-color: #d32f2f;">Cancelar</button>
                  <button id="salvar-resultados" class="button">Salvar Resultados</button>
                </div>
                
                <button id="fechar-modal-resultados" 
                    style="position: absolute; top: 15px; right: 15px; padding: 5px 10px; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  X
                </button>
              </div>
            `;
            
            modal.innerHTML = resultadosHTML;
            document.body.appendChild(modal);
            
            // Event listeners para o modal
            document.getElementById("fechar-modal-resultados").onclick = () => {
              document.body.removeChild(modal);
            };
            
            document.getElementById("cancelar-resultados").onclick = () => {
              document.body.removeChild(modal);
            };
            
            document.getElementById("salvar-resultados").onclick = async () => {
              try {
                mostrarLoading();
                
                // Coletar os dados do formulário
                const resultados = {
                  negativas: document.getElementById("negativas").value,
                  titulo4: document.getElementById("titulo4").value,
                  titulo8: document.getElementById("titulo8").value,
                  titulo16: document.getElementById("titulo16").value,
                  titulo32: document.getElementById("titulo32").value,
                  titulo64: document.getElementById("titulo64").value,
                  titulo128: document.getElementById("titulo128").value,
                  titulo256: document.getElementById("titulo256").value,
                  titulo512: document.getElementById("titulo512").value,
                  improprias: document.getElementById("improprias").value,
                  toxicas: document.getElementById("toxicas").value,
                  insuficiente: document.getElementById("insuficiente").value,
                  dataRegistro: Timestamp.now()
                };
                
                // Atualizar no Firestore
                await updateDoc(tarefaRef, {
                  resultados: resultados,
                  status: "resultados-registrados",
                  atualizadoEm: Timestamp.now()
                });
                
                document.body.removeChild(modal);
                carregarTarefas();
                mostrarFeedback("Resultados salvos com sucesso!", "success");
              } catch (error) {
                console.error("Erro ao salvar resultados:", error);
                mostrarFeedback(`Erro: ${error.message}`, "error");
              } finally {
                esconderLoading();
              }
            };
            
            // Fechar modal ao clicar fora ou pressionar ESC
            modal.onclick = (e) => {
              if (e.target === modal) {
                document.body.removeChild(modal);
              }
            };
            
            document.addEventListener("keydown", (e) => {
              if (e.key === "Escape") {
                document.body.removeChild(modal);
              }
            });
            
          } catch (error) {
            console.error("Erro ao registrar resultado:", error);
            mostrarFeedback(`Erro: ${error.message}`, "error");
          } finally {
            esconderLoading();
          }
        };

        // Adiciona eventos para o dropdown em mobile
        document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
          // Controle por clique
          toggle.addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = this.closest('.actions-dropdown');
            
            // Fecha outros dropdowns
            document.querySelectorAll('.actions-dropdown').forEach(d => {
              if (d !== dropdown) d.classList.remove('active');
            });
            
            // Alterna o atual
            dropdown.classList.toggle('active');
          });
        });

        // Fecha dropdowns ao clicar fora
        document.addEventListener('click', function(e) {
          if (!e.target.closest('.actions-dropdown')) {
            document.querySelectorAll('.actions-dropdown').forEach(d => {
              d.classList.remove('active');
            });
          }
        });

        // Fecha ao rolar a página (opcional)
        window.addEventListener('scroll', function() {
          document.querySelectorAll('.actions-dropdown').forEach(dropdown => {
            dropdown.classList.remove('active');
          });
        });

        // Adiciona hover apenas para desktop
        if (window.innerWidth > 480) {
          document.querySelectorAll('.amostra-item').forEach(item => {
            item.addEventListener('mouseenter', function() {
              this.style.zIndex = '11';
            });
            
            item.addEventListener('mouseleave', function() {
              // Sempre restaura o z-index quando o mouse sai
              this.style.zIndex = '';
              
              // Fecha qualquer dropdown aberto
              const dropdown = this.querySelector('.actions-dropdown');
              if (dropdown) dropdown.classList.remove('active');
            });
          });
          
          // Fecha dropdown quando o mouse sai dele
          document.querySelectorAll('.dropdown-content').forEach(dropdown => {
            dropdown.addEventListener('mouseleave', function() {
              this.closest('.actions-dropdown').classList.remove('active');
            });
          });
        }

      } catch (error) {
        console.error("Erro ao carregar tarefas:", error);
        muralList.innerHTML = `
          <p class="error">Erro ao carregar tarefas: ${error.message}</p>
          <p>Verifique o console para mais detalhes.</p>
        `;
      } finally {
        esconderLoading();
      }
    }
  
    async function adicionarTarefa(e) {
      e.preventDefault();
      mostrarLoading();
      
      try {
        const user = auth.currentUser;
        if (!user) throw new Error("Usuário não autenticado");

        let siglaUsuario = "N/A";
        try {
          const usuarioRef = doc(db, "usuarios", user.uid);
          const usuarioSnap = await getDoc(usuarioRef);
          
          if (usuarioSnap.exists()) {
            siglaUsuario = usuarioSnap.data().sigla || "N/A";
          } else {
            const usuarioLocal = JSON.parse(localStorage.getItem("usuario"));
            if (usuarioLocal?.sigla) siglaUsuario = usuarioLocal.sigla;
          }
        } catch (error) {
          console.error("Erro ao buscar usuário:", error);
        }

        const dataInput = document.getElementById("data").value;
        const dataLocal = new Date(dataInput);
        const dataUTC = new Date(dataLocal.getTime() + dataLocal.getTimezoneOffset() * 60000);

        const novaTarefa = {
          id: document.getElementById("id").value.trim(),
          tipo: document.getElementById("tipo").value,
          complemento: (document.getElementById("tipo").value === "PCR" || 
                       document.getElementById("tipo").value === "RAIVA")
                    ? document.getElementById("complemento").value.trim()
                    : null,
          quantidade: parseInt(document.getElementById("quantidade").value),
          gramatura: document.getElementById("tipo").value === "VACINA" 
                    ? (document.getElementById("gramatura").value 
                       ? parseFloat(document.getElementById("gramatura").value)
                       : null)
                    : null,
          proprietario: document.getElementById("proprietario").value.trim(),
          dataRecebimento: dataUTC,
          observacoes: document.getElementById("observacoes").value.trim(),
          status: "pendente",
          criadoEm: Timestamp.now(),
          criadoPor: user.uid,
          siglaResponsavel: siglaUsuario
        };
  
        if (!novaTarefa.id) throw new Error("ID é obrigatório");
        if (isNaN(novaTarefa.quantidade)) throw new Error("Quantidade inválida");
        if (novaTarefa.quantidade <= 0) throw new Error("Quantidade deve ser maior que zero");
        
  
        await addDoc(collection(db, "tarefas"), {
          ...novaTarefa,
          dataRecebimento: Timestamp.fromDate(dataUTC)
        });
      
        esconderFormulario();
        carregarTarefas();
        mostrarFeedback("Tarefa adicionada com sucesso!", "success");
      } catch (error) {
        console.error("Erro ao adicionar tarefa:", error);
        mostrarFeedback(`Erro: ${error.message}`, "error");
      } finally {
        esconderLoading();
      }
    }
  
    // Funções globais
    window.marcarProgresso = async (id) => {
      try {
        const tarefaRef = doc(db, "tarefas", id);
        const tarefaSnap = await getDoc(tarefaRef);
        
        if (!tarefaSnap.exists()) throw new Error("Tarefa não encontrada");
        
        const tarefa = tarefaSnap.data();
        const novoStatus = tarefa.status === 'em-progresso' ? 'pendente' : 'em-progresso';
        
        await updateDoc(tarefaRef, { 
          status: novoStatus,
          atualizadoEm: Timestamp.now()
        });
        
        carregarTarefas(document.getElementById("filtro-tipo").value);
        mostrarFeedback(`Tarefa marcada como ${novoStatus === 'em-progresso' ? 'em progresso' : 'pendente'}`, "success");
      } catch (error) {
        console.error("Erro ao atualizar status:", error);
        mostrarFeedback(`Erro: ${error.message}`, "error");
      }
    };
  
    window.concluirTarefa = async (id) => {
      try {
        if (!confirm("Tem certeza que deseja concluir esta tarefa?")) return;
        mostrarLoading();
        
        const tarefaRef = doc(db, "tarefas", id);
        const tarefaSnap = await getDoc(tarefaRef);
        
        if (!tarefaSnap.exists()) throw new Error("Tarefa não encontrada");
        
        const tarefa = tarefaSnap.data();
        await addDoc(collection(db, "historico"), {
          ...tarefa,
          dataConclusao: Timestamp.now(),
          concluidoPor: auth.currentUser.uid
        });
        
        await deleteDoc(tarefaRef);
        carregarTarefas();
        mostrarFeedback("Tarefa concluída com sucesso!", "success");
      } catch (error) {
        console.error("Erro ao concluir:", error);
        mostrarFeedback(`Erro: ${error.message}`, "error");
      } finally {
        esconderLoading();
      }
    };
  
    window.excluirTarefa = async (id) => {
      try {
        if (!confirm("Tem certeza que deseja excluir esta tarefa?")) return;
        mostrarLoading();
        
        await deleteDoc(doc(db, "tarefas", id));
        carregarTarefas();
        mostrarFeedback("Tarefa excluída com sucesso!", "success");
      } catch (error) {
        console.error("Erro ao excluir:", error);
        mostrarFeedback(`Erro: ${error.message}`, "error");
      } finally {
        esconderLoading();
      }
    };
  
    window.editarTarefa = async (id) => {
      try {
        mostrarLoading();
        const tarefaRef = doc(db, "tarefas", id);
        const tarefaSnap = await getDoc(tarefaRef);
        
        if (!tarefaSnap.exists()) throw new Error("Tarefa não encontrada");
        
        const tarefa = tarefaSnap.data();
        document.getElementById("id").value = tarefa.id;
        document.getElementById("tipo").value = tarefa.tipo;
        document.getElementById("quantidade").value = tarefa.quantidade;
        
        // Mostrar/ocultar campos condicionais
        const tipo = tarefa.tipo;
        if (tipo === "VACINA") {
          document.getElementById("gramatura-container").style.display = "block";
          document.getElementById("gramatura").value = tarefa.gramatura || "";
        } else {
          document.getElementById("gramatura-container").style.display = "none";
        }
        
        if (tipo === "PCR" || tipo === "RAIVA") {
          document.getElementById("complemento-container").style.display = "block";
          document.getElementById("complemento").value = tarefa.complemento || "";
        } else {
          document.getElementById("complemento-container").style.display = "none";
        }
        
        const dataRecebimento = tarefa.dataRecebimento?.toDate();
        if (dataRecebimento) {
          const dataLocal = new Date(dataRecebimento.getTime() - dataRecebimento.getTimezoneOffset() * 60000);
          document.getElementById("data").value = dataLocal.toISOString().split("T")[0];
        }
        
        document.getElementById("observacoes").value = tarefa.observacoes || "";

        document.getElementById("proprietario").value = tarefa.proprietario || "";
        
        mostrarFormulario(true);
        
        document.getElementById("mural-form").onsubmit = async (e) => {
          e.preventDefault();
          try {
            mostrarLoading();
            
            const dataInput = document.getElementById("data").value;
            const dataLocal = new Date(dataInput);
            const dataUTC = new Date(dataLocal.getTime() + dataLocal.getTimezoneOffset() * 60000);
            
            await updateDoc(tarefaRef, {
              id: document.getElementById("id").value,
              tipo: document.getElementById("tipo").value,
              quantidade: parseInt(document.getElementById("quantidade").value),
              gramatura: document.getElementById("tipo").value === "VACINA" 
                        ? (document.getElementById("gramatura").value 
                           ? parseFloat(document.getElementById("gramatura").value) 
                           : null)
                        : null,
              complemento: (document.getElementById("tipo").value === "PCR" || 
                           document.getElementById("tipo").value === "RAIVA")
                        ? document.getElementById("complemento").value.trim()
                        : null,
              proprietario: document.getElementById("proprietario").value.trim(),
              dataRecebimento: Timestamp.fromDate(dataUTC),
              atualizadoEm: Timestamp.now(),
              observacoes: document.getElementById("observacoes").value.trim()
            });
            
            esconderFormulario();
            carregarTarefas();
            mostrarFeedback("Tarefa atualizada com sucesso!", "success");
          } catch (error) {
            console.error("Erro ao atualizar:", error);
            mostrarFeedback(`Erro: ${error.message}`, "error");
          } finally {
            esconderLoading();
          }
        };
      } catch (error) {
        console.error("Erro ao editar:", error);
        mostrarFeedback(`Erro: ${error.message}`, "error");
      } finally {
        esconderLoading();
      }
    };
  
    window.mostrarDetalhes = async (id) => {
      try {
        mostrarLoading();
        const docRef = doc(db, "tarefas", id);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) throw new Error("Tarefa não encontrada");
        
        const tarefa = docSnap.data();
        let siglaUsuario = "N/A";
  
        if (tarefa.siglaResponsavel) {
          siglaUsuario = tarefa.siglaResponsavel;
        } else if (tarefa.criadoPor) {
          const usuarioRef = doc(db, "usuarios", tarefa.criadoPor);
          const usuarioSnap = await getDoc(usuarioRef);
          if (usuarioSnap.exists()) {
            siglaUsuario = usuarioSnap.data().sigla || "N/A";
          }
        }
  
        const dataRecebimento = tarefa.dataRecebimento?.toDate 
          ? formatarDataParaExibicao(tarefa.dataRecebimento.toDate())
          : "Data não disponível";
        
        const modal = document.createElement("div");
        modal.id = "modal-detalhes";
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
        `;
  
        const modalContent = document.createElement("div");
        modalContent.style.cssText = `
          background: white;
          padding: 25px;
          border-radius: 10px;
          max-width: 90%;
          max-height: 90vh;
          overflow-y: auto;
          width: 500px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          position: relative;
        `;
  
        modalContent.innerHTML = `
          <h3 style="margin-bottom: 15px; margin-top: 0px; color: #1b5e20;">Detalhes da Tarefa</h3>
          
          <div style="margin-bottom: 15px;">
            <strong style="display: inline-block; width: 120px;">ID:</strong>
            <span>${tarefa.id || 'N/A'}</span>
          </div>
          
          <div style="margin-bottom: 15px;">
            <strong style="display: inline-block; width: 120px;">Tipo:</strong>
            <span>${tarefa.tipo || 'N/A'}</span>
          </div>
  
          <div style="margin-bottom: 15px;">
            <strong style="display: inline-block; width: 120px;">Responsável:</strong>
            <span>${siglaUsuario}</span>
          </div>

          <div style="margin-bottom: 15px;">
            <strong style="display: inline-block; width: 120px;">Quantidade:</strong>
            <span>${tarefa.quantidade || '0'} ${tarefa.tipo === "VACINA" 
              ? `vacinas${tarefa.gramatura ? ` (${tarefa.gramatura}g)` : ''}` 
              : "amostras"}</span>
          </div>

          ${tarefa.complemento ? `
          <div style="margin-bottom: 15px;">
            <strong style="display: inline-block; width: 120px;">Complemento:</strong>
            <span>${tarefa.complemento.trim()}</span>
          </div>` : ''}

          <div style="margin-bottom: 15px;">
            <strong style="display: inline-block; width: 120px;">Proprietário:</strong>
            <span>${tarefa.proprietario || 'N/A'}</span>
          </div>
          
          <div style="margin-bottom: 15px;">
            <strong style="display: inline-block; width: 120px;">Recebimento:</strong>
            <span>${dataRecebimento}</span>
          </div>
          
          <div style="margin-bottom: 15px;">
            <strong style="display: inline-block; width: 120px;">Status:</strong>
            <span>${tarefa.status === 'em-progresso' ? 'Em Progresso' : 'Pendente'}</span>
          </div>
          
          ${tarefa.observacoes ? `
          <div style="margin-bottom: 20px;">
            <strong style="display: block; margin-bottom: 5px;">Observações:</strong>
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid #1b5e20; white-space: pre-line; text-align: left;">
              ${tarefa.observacoes.trim()}
            </div>
          </div>` : ''}
          
          <button id="fechar-modal" 
              style="position: absolute; top: 15px; right: 15px; padding: 5px 10px; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer;">
            X
          </button>
        `;
  
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
  
        document.getElementById("fechar-modal").onclick = () => {
          document.body.removeChild(modal);
        };
  
        modal.onclick = (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        };
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") document.body.removeChild(modal);
        });
  
      } catch (error) {
        console.error("Erro ao mostrar detalhes:", error);
        mostrarFeedback(`Erro: ${error.message}`, "error");
      } finally {
        esconderLoading();
      }
    };

    async function carregarProprietariosSugeridos() {
      try {
        const proprietariosRef = collection(db, "proprietarios");
        const querySnapshot = await getDocs(proprietariosRef);
        const datalist = document.getElementById("proprietarios-list");
        
        // Limpa a lista atual
        datalist.innerHTML = "";
        
        // Adiciona cada proprietário como uma opção
        querySnapshot.forEach((doc) => {
          const proprietario = doc.data().nome;
          const option = document.createElement("option");
          option.value = proprietario;
          datalist.appendChild(option);
        });
      } catch (error) {
        console.error("Erro ao carregar proprietários:", error);
      }
    }
  
    // Inicialização
    document.addEventListener("DOMContentLoaded", () => {
      // Event Listeners
      document.getElementById("adicionar-tarefa").onclick = () => mostrarFormulario();
      document.getElementById("cancelar-tarefa").onclick = esconderFormulario;
      
      document.getElementById("tipo").addEventListener("change", function() {

        const showGramatura = this.value === "VACINA";
        document.getElementById("gramatura-container").style.display = showGramatura ? "block" : "none";

        const showComplemento = this.value === "PCR" || this.value === "RAIVA";
        const complementoContainer = document.getElementById("complemento-container");
        complementoContainer.style.display = showComplemento ? "block" : "none";
        document.getElementById("complemento").required = showComplemento;
      });
  
      document.getElementById("filtro-ordem").addEventListener("change", (e) => {
        const filtroTipo = document.getElementById("filtro-tipo").value;
        carregarTarefas(filtroTipo, e.target.value);
      });
  
      document.getElementById("filtro-tipo").addEventListener("change", (e) => {
        const ordem = document.getElementById("filtro-ordem").value;
        carregarTarefas(e.target.value, ordem);
      });
  
      document.getElementById("hub-button").onclick = () => {
        window.location.href = "hub.html";
      };
  
      document.getElementById("historico-button").onclick = () => {
        window.location.href = "historico.html";
      };
  
      // Autenticação
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("Usuário autenticado:", user.uid);
          carregarProprietariosSugeridos(); // Adicione esta linha
          carregarTarefas();
        } else {
          console.log("Usuário não autenticado.");
          window.location.href = "index.html";
        }
      });
    });
  </script>
</body>
</html>